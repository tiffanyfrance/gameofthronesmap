<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leaflet</title>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .leaflet-container {
      background: #222;
    }
    #mapid {
      height: 100%;
    }
  </style>
</head>
<body>

  <div id="mapid"></div>

  <script>
    var map = L.map('mapid').setView([0,0], 3);

    L.tileLayer('GOT/GOT/{z}/{x}/{y}.png', {
        maxZoom: 5,
        minZoom: 1,
        noWrap: true,
        crs: L.CRS.Simple
    }).addTo(map);

    var southWest = map.unproject([200, 6700], map.getMaxZoom());
    var northEast = map.unproject([8000, 1500], map.getMaxZoom());
    map.setMaxBounds(new L.LatLngBounds(southWest, northEast));

    map.on("click", function(e) {
      console.log(e.latlng)
    });

    // var khalessiIcon = L.icon({
    //   iconUrl: 'GOT/images/khalessi.png',
    //   shadowUrl: 'GOT/images/shadow.png',
    //   iconSize:     [40, 40], // size of the icon
    //   iconAnchor:   [40, 40], // point of the icon which will correspond to marker's location
    //   shadowSize: [44, 44],
    //   shadowAnchor: [42, 42]
    // });

    // var khalessi = L.marker([-1.142502403706165, -71.8505859375], {icon: khalessiIcon}).addTo(map);



   var LeafIcon = L.Icon.extend({
      options: {
        shadowUrl: 'GOT/images/shadow.png',
        iconSize:     [40, 40],
        iconAnchor:   [40, 40], // point of the icon which will correspond to marker's location
        shadowSize:   [44, 44],
        shadowAnchor: [42, 42],
        popupAnchor:  [-20, -44]
      }
    });

    $.getJSON('got.json', function(data) {

      var overlay = {};

      for (var i = 0; i < data.length; i++) {

        var groupChars = [];

        for (var j = 0; j < data[i].chars.length; j++) {
          let character = data[i].chars[j];
          let icon = new LeafIcon({iconUrl: 'GOT/images/' + character.iconUrl});
          let desc = $(character.description)[0];
          let marker = L.marker(character.coords, {icon: icon}).bindPopup(desc);

          groupChars.push(marker);

          if (character.pathCoords) {
            $(desc).find('.animateKhalessi').on('click', function() {
              marker.closePopup();

              let geojson = { type: 'LineString', coordinates: character.pathCoords };
              // Create a counter with a value of 0.
              let j = 0;
              // Create a marker and add it to the map.
              // var marker = L.marker([0, 0]).addTo(map);
              tick();
              function tick() {
                // Set the marker to be at the same point as one
                // of the segments or the line.
                marker.setLatLng(L.latLng(
                  geojson.coordinates[j][0],
                  geojson.coordinates[j][1]));
                // Move to the next point of the line
                // until `j` reaches the length of the array.
                if (++j < geojson.coordinates.length) setTimeout(tick, 100);
              };
            });
          }





        }

        var layerGroup = L.layerGroup(groupChars);
        map.addLayer(layerGroup);
        overlay[data[i].layer] = layerGroup;
      };

      L.control.layers(null, overlay).addTo(map);



    });

    // TODO button for path
    // var btn = L.DomUtil.create('button');
    // btn.innerHTML = "follow";
    // var container = L.DomUtil.create('div');
    // container.innerHTML = "Daenerys Targaryen, called 'Daenerys Stormborn' and 'Mother of Dragons', self-styled 'Khaleesi of the Great Grass Sea'. Widow of Khal Drogo, the Great Khal of his generation. She currently leads a khalasar of 100,000, the bulk of the Dothraki's fighting population.<br />";
    // container.appendChild(btn);


// // var foo = "<button>see path</button>";
// // khalessi.bindPopup("Daenerys Targaryen, called 'Daenerys Stormborn' and 'Mother of Dragons', self-styled 'Khaleesi of the Great Grass Sea'. Widow of Khal Drogo, the Great Khal of his generation. She currently leads a khalasar of 100,000, the bulk of the Dothraki's fighting population.<br />" + foo);

    // foo.addEventListener('click', function() {


  </script>

</body>
</html>